doctype html
html
  head
    title= title
    meta(charset='utf-8')
    meta(name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no')
    link(rel='stylesheet', href='/css/bootstrap.min.css')
    link(rel='stylesheet', href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css')
    link(rel='stylesheet', href='https://pro.fontawesome.com/releases/v5.10.0/css/all.css' integrity='sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p' crossorigin='anonymous')
    style.
      .label-text { font-weight:600;font-size:1.3rem }
      .label-blue { color:rgba(10,109,154); font-weight:400; font-size:1rem }
      .label-hint { color:rgba(129,129,129);font-weight:400; font-size:1rem }
      .backdrop-filter { 
        background: rgba(255, 255, 255, .01);
        position:absolute ;  z-index:3;  
        -webkit-backdrop-filter: blur(5px);
        backdrop-filter: blur(5px);
      }
      .backdrop-text {
        height: 600px;
        vertical-align: top;
        text-align: center;
        font-size: 60px;
        font-weight:600;
      }
      .backdrop-text:before {
        content: "";
        display: inline-block;
        width: 0;
        height: 100%;
        vertical-align: middle;
      }
      .backdrop-text p {
        display: inline-block;
      }
      .lds-spinner {
        color: official;
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
      }
      .lds-spinner div {
        transform-origin: 40px 40px;
        animation: lds-spinner 1.2s linear infinite;
      }
      .lds-spinner div:after {
        content: " ";
        display: block;
        position: absolute;
        top: 3px;
        left: 37px;
        width: 6px;
        height: 18px;
        border-radius: 20%;
        background-color: #000;
      }
      .lds-spinner div:nth-child(1) {
        transform: rotate(0deg);
        animation-delay: -1.1s;
      }
      .lds-spinner div:nth-child(2) {
        transform: rotate(30deg);
        animation-delay: -1s;
      }
      .lds-spinner div:nth-child(3) {
        transform: rotate(60deg);
        animation-delay: -0.9s;
      }
      .lds-spinner div:nth-child(4) {
        transform: rotate(90deg);
        animation-delay: -0.8s;
      }
      .lds-spinner div:nth-child(5) {
        transform: rotate(120deg);
        animation-delay: -0.7s;
      }
      .lds-spinner div:nth-child(6) {
        transform: rotate(150deg);
        animation-delay: -0.6s;
      }
      .lds-spinner div:nth-child(7) {
        transform: rotate(180deg);
        animation-delay: -0.5s;
      }
      .lds-spinner div:nth-child(8) {
        transform: rotate(210deg);
        animation-delay: -0.4s;
      }
      .lds-spinner div:nth-child(9) {
        transform: rotate(240deg);
        animation-delay: -0.3s;
      }
      .lds-spinner div:nth-child(10) {
        transform: rotate(270deg);
        animation-delay: -0.2s;
      }
      .lds-spinner div:nth-child(11) {
        transform: rotate(300deg);
        animation-delay: -0.1s;
      }
      .lds-spinner div:nth-child(12) {
        transform: rotate(330deg);
        animation-delay: 0s;
      }
        @keyframes lds-spinner {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }


  body
    script(src='/js/jquery.min.js')
    script(src='/js/bootstrap.min.js')
    script(src='https://unpkg.com/bootstrap-show-password@1.2.1/dist/bootstrap-show-password.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js' integrity='sha512-d9xgZrVZpmmQlfonhQUvTR7lMPtO7NkZMkA0ABN3PHCbKA5nqylQ/yWlFAyY6hYgdF1Qh6nYiuADWwKB4C2WSw==' crossorigin='anonymous')
  

    nav.navbar.navbar-expand-lg.navbar-dark.bg-dark
      .container-fluid
        button.navbar-toggler(type='button', data-bs-toggle='collapse', data-bs-target='#navbarTogglerDemo01', aria-controls='navbarTogglerDemo01', aria-expanded='false', aria-label='Toggle navigation')
          span.navbar-toggler-icon
        |     
        #navbarTogglerDemo01.collapse.navbar-collapse
          a.navbar-brand(href='/tsp') TSP
          |       
          ul.navbar-nav.ml-auto.mb-2.mb-lg-0
            if user
                li.nav-item.navbar-light
                a.nav-link.active(href='/tsp/setting' style='background-color: #5B5B5B;border-radius:30px;margin-right:5px;')
                    i.bi.bi-controller
                    |   Setting
                li.nav-item.navbar-light
                a.nav-link.active(href='/tsp/logout' style='background-color: #5B5B5B;border-radius:30px;margin-right:5px;')
                    i.bi.bi-box-arrow-right
                    |   Logout
            if !user
                li.nav-item.navbar-light
                a.nav-link.signIn.active(href='#' data-toggle='modal' data-target='#signInModal' style='background-color: #5B5B5B;border-radius:30px;margin-right:3px;')
                    i.bi-person-circle
                    |   Sign in

    
     #signInModal.modal.fade(tabindex='-1' role='dialog')
        .modal-dialog.modal-dialog-centered(role='document')
            .modal-content
                .modal-header
                    h5.modal-title Sign in with Metamask
                    button.close(type='button' data-dismiss='modal' aria-label='Close')
                        span(aria-hidden='true') ×
                .modal-body
                    p 是否使用該帳戶登入?
                    p 目前帳戶(Address)
                    p.address.text-uppercase.font-weight-bold.text-center ...
                .modal-footer
                    button.btn.btn-primary.loginWithMetamask(type='button') 繼續
                    button.btn.btn-secondary(type='button' data-dismiss='modal') 關閉
                   
    .container.mt-2
      block content

    footer.my-5.pt-5.text-muted.text-center.text-small
      p.mb-1 © 2020–2021 TSP
      ul.list-inline
        li.list-inline-item
          a(href='#') Privacy
        li.list-inline-item
          a(href='#') Terms
        li.list-inline-item
          a(href='#') Support
    script.
        $(function() {
            const emptyAddress = "0x0000000000000000000000000000000000000000000000000000000000000000";
            let contract_address = "#{address}";
            let account = "";
            let contractInstance;


            window.ethereum.on('accountsChanged', function(accounts) {
                account = accounts[0];
                $("#signInModal").find('.modal-body .address').text(account);                
            });

            $(".loginWithMetamask").on('click',function(e){

                $.getJSON('../metamask-connect/org.json', function (data) {
                    contractInstance = new web3.eth.Contract(data.abi, contract_address);

                    contractInstance.methods.getId().call({from: account})
                    .then( (result) => {
                        if (result === emptyAddress)
                            return Promise.reject("該帳戶尚未進行綁定！");
                        else
                        {
                            return Promise.resolve(result);
                        }
                    })
                    .then( (result) =>{
                        web3.eth.personal.sign(result, account).then((res) => {
                            contractInstance.methods.getOrgList().call({from: account})
                            .then( async (orgs) => {
                                let register_orgs = [];
                                for (var i = 0; i < orgs.length; i++) {
                                    await contractInstance.methods.isRegistered(orgs[i]).call({from: account})
                                    .then ( (r) => { // boolean
                                        console.log(orgs[i], r);
                                        if (r) {
                                            register_orgs.push(orgs[i].toUpperCase());
                                        }
                                    })
                                }
                                console.log(register_orgs)

                                $.ajax({
                                    url: '/tsp/loginWithMetamask',
                                    data: { 
                                        identity: result, // identity
                                        signature: res,   // signature
                                        account: account, // account
                                        provider_address: JSON.stringify(register_orgs)
                                    },
                                    type: 'post',
                                    success: function(res) {
                                        console.log("success");
                                        
                                        console.log(res.url)
                                        //- window.location.replace("/profile");
                                        //location.href = 
                                        if (res.url)
                                            window.location.href = res.url;
                                    },
                                    error: function(err) {
                                        console.log("error");
                                        alert();
                                    }
                                });
                                
                            })
                        })

                    })
                    .catch( (err) => {
                            alert(err);
                    });
                });
                
                
                
            })

            $(".signIn").on('click', function(e) {
                $.getScript("/javascripts/web3_bundle.js", function(data, textStatus, jqxhr) { 

                    web3.eth.getAccounts().then((accounts) => {
                        account = accounts[0];
                        $("#signInModal").find('.modal-body .address').text(account);
                    });
                    
                });
                /*
                $.getScript("/javascripts/web3_bundle.js", function(d, textStatus, jqxhr) {                        
                    $.getJSON('metamask-connect/org.json', function (data) {
                    
                    });
                });
                */

            });



            




        //    $(window).ready(() => {
        //        $('#signInModal').modal('show');
        //    })

        });
        